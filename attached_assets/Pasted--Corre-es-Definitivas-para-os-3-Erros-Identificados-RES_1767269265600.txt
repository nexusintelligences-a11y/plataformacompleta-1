# Corre√ß√µes Definitivas para os 3 Erros Identificados

## üéØ RESUMO EXECUTIVO

| Erro | Causa Raiz | Solu√ß√£o | Status |
|------|-----------|---------|--------|
| **1. Database** | Tabela `contracts` n√£o existe | `db:push --force` | ‚úÖ Resolvido |
| **2. Valida√ß√£o Zod** | Strings vazias em campos opcionais | Atualizar schema Zod | ‚ö†Ô∏è Precisa corre√ß√£o |
| **3. Estrutura Request** | Objetos aninhados vs colunas flat | Mapear dados no frontend | ‚ö†Ô∏è Precisa corre√ß√£o |

---

## üîß CORRE√á√ÉO 1: Banco de Dados (RESOLVIDO)

### Status Atual
‚úÖ Resolvido com `npm run db:push --force`

### Verifica√ß√£o P√≥s-Corre√ß√£o
Execute para confirmar que a tabela existe:

```sql
-- No PostgreSQL ou via c√≥digo
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'contracts'
ORDER BY ordinal_position;
```

### Se Precisar Recriar Manualmente
```sql
-- Apenas se o db:push n√£o funcionar
DROP TABLE IF EXISTS contracts CASCADE;

-- Depois execute:
-- npm run db:push --force
```

---

## üîß CORRE√á√ÉO 2: Valida√ß√£o Zod (CR√çTICO)

### Problema Identificado
```typescript
// ‚ùå ANTES (Schema rejeitava strings vazias)
logo_url: z.string().url().optional()

// Quando frontend envia:
{ logo_url: "" } // ‚ùå Erro: "Invalid URL"
```

### Solu√ß√£o Completa

**Arquivo: `assinatura/shared/schema.ts`**

```typescript
import { pgTable, serial, varchar, text, timestamp, decimal, boolean, uuid } from "drizzle-orm/pg-core";
import { z } from "zod";

// ========================================
// TABELA CONTRACTS
// ========================================
export const contracts = pgTable("contracts", {
  id: serial("id").primaryKey(),
  
  // Identifica√ß√£o
  access_token: uuid("access_token").defaultRandom().unique().notNull(),
  
  // Dados do cliente (OBRIGAT√ìRIOS)
  client_name: varchar("client_name", { length: 255 }).notNull(),
  client_cpf: varchar("client_cpf", { length: 20 }).notNull(),
  client_email: varchar("client_email", { length: 255 }).notNull(),
  
  // Dados de contato (OPCIONAIS)
  client_phone: varchar("client_phone", { length: 20 }),
  client_address: text("client_address"),
  client_city: varchar("client_city", { length: 100 }),
  client_state: varchar("client_state", { length: 2 }),
  client_zip: varchar("client_zip", { length: 10 }),
  
  // Conte√∫do
  contract_html: text("contract_html").notNull(),
  
  // Status
  status: varchar("status", { length: 50 }).default("pending"),
  created_at: timestamp("created_at").defaultNow(),
  signed_at: timestamp("signed_at"),
  
  // Verifica√ß√£o facial
  verification_selfie: text("verification_selfie"),
  verification_document: text("verification_document"),
  face_match_score: decimal("face_match_score", { precision: 5, scale: 2 }),
  
  // ========================================
  // PERSONALIZA√á√ÉO - APAR√äNCIA
  // ========================================
  logo_url: text("logo_url"),
  primary_color: varchar("primary_color", { length: 7 }).default("#3B82F6"),
  text_color: varchar("text_color", { length: 7 }).default("#1F2937"),
  font_family: varchar("font_family", { length: 100 }).default("Inter"),
  company_name: varchar("company_name", { length: 255 }),
  footer_text: text("footer_text"),
  
  // ========================================
  // PERSONALIZA√á√ÉO - VERIFICA√á√ÉO
  // ========================================
  verification_instructions: text("verification_instructions"),
  verification_security_message: text("verification_security_message"), // NOVO CAMPO
  verification_icon_url: text("verification_icon_url"), // NOVO CAMPO
  security_message: text("security_message"),
  header_background_color: varchar("header_background_color", { length: 7 }),
  
  // ========================================
  // PERSONALIZA√á√ÉO - TRACKER DE PROGRESSO
  // ========================================
  progress_step1_text: varchar("progress_step1_text", { length: 255 }),
  progress_step2_text: varchar("progress_step2_text", { length: 255 }),
  progress_step3_text: varchar("progress_step3_text", { length: 255 }),
  progress_step4_text: varchar("progress_step4_text", { length: 255 }),
  
  // ========================================
  // PERSONALIZA√á√ÉO - TELA DE SUCESSO
  // ========================================
  success_title: varchar("success_title", { length: 255 }),
  success_message: text("success_message"),
  success_button_text: varchar("success_button_text", { length: 100 }),
  
  // ========================================
  // LINKS DE APLICATIVOS
  // ========================================
  app_store_url: text("app_store_url"),
  play_store_url: text("play_store_url"),
  
  // ========================================
  // GOV.BR
  // ========================================
  govbr_token_hash: varchar("govbr_token_hash", { length: 255 }),
  govbr_cpf: varchar("govbr_cpf", { length: 20 }),
  govbr_validated: boolean("govbr_validated").default(false),
});

// ========================================
// SCHEMA ZOD DE VALIDA√á√ÉO (CORRIGIDO)
// ========================================

// Helper para aceitar strings vazias ou URLs v√°lidas
const optionalUrlOrEmpty = z.string().optional().refine(
  (val) => !val || val === "" || z.string().url().safeParse(val).success,
  { message: "Deve ser uma URL v√°lida ou vazio" }
);

// Helper para aceitar strings vazias ou hex colors
const optionalColorOrEmpty = z.string().optional().refine(
  (val) => !val || val === "" || /^#[0-9A-Fa-f]{6}$/.test(val),
  { message: "Deve ser uma cor hex v√°lida (#RRGGBB) ou vazio" }
);

export const insertContractSchema = z.object({
  // ========================================
  // CAMPOS OBRIGAT√ìRIOS
  // ========================================
  client_name: z.string().min(1, "Nome √© obrigat√≥rio"),
  
  client_cpf: z.string()
    .min(11, "CPF deve ter 11 d√≠gitos")
    .max(14, "CPF inv√°lido")
    .transform((val) => val.replace(/\D/g, "")) // Remove m√°scara automaticamente
    .refine((val) => val.length === 11, "CPF deve ter 11 d√≠gitos"),
  
  client_email: z.string()
    .email("Email inv√°lido")
    .min(1, "Email √© obrigat√≥rio"),
  
  contract_html: z.string().min(1, "Conte√∫do do contrato √© obrigat√≥rio"),
  
  // ========================================
  // CAMPOS OPCIONAIS - CONTATO
  // ========================================
  client_phone: z.string().optional().or(z.literal("")),
  client_address: z.string().optional().or(z.literal("")),
  client_city: z.string().optional().or(z.literal("")),
  client_state: z.string().max(2).optional().or(z.literal("")),
  client_zip: z.string().optional().or(z.literal("")),
  
  // ========================================
  // CAMPOS OPCIONAIS - APAR√äNCIA
  // ========================================
  logo_url: optionalUrlOrEmpty,
  primary_color: optionalColorOrEmpty,
  text_color: optionalColorOrEmpty,
  font_family: z.string().optional().or(z.literal("")),
  company_name: z.string().optional().or(z.literal("")),
  footer_text: z.string().optional().or(z.literal("")),
  
  // ========================================
  // CAMPOS OPCIONAIS - VERIFICA√á√ÉO
  // ========================================
  verification_instructions: z.string().optional().or(z.literal("")),
  verification_security_message: z.string().optional().or(z.literal("")), // NOVO
  verification_icon_url: optionalUrlOrEmpty, // NOVO
  security_message: z.string().optional().or(z.literal("")),
  header_background_color: optionalColorOrEmpty,
  
  // ========================================
  // CAMPOS OPCIONAIS - TRACKER
  // ========================================
  progress_step1_text: z.string().optional().or(z.literal("")),
  progress_step2_text: z.string().optional().or(z.literal("")),
  progress_step3_text: z.string().optional().or(z.literal("")),
  progress_step4_text: z.string().optional().or(z.literal("")),
  
  // ========================================
  // CAMPOS OPCIONAIS - SUCESSO
  // ========================================
  success_title: z.string().optional().or(z.literal("")),
  success_message: z.string().optional().or(z.literal("")),
  success_button_text: z.string().optional().or(z.literal("")),
  
  // ========================================
  // CAMPOS OPCIONAIS - APPS
  // ========================================
  app_store_url: optionalUrlOrEmpty,
  play_store_url: optionalUrlOrEmpty,
});

export type InsertContract = z.infer<typeof insertContractSchema>;
export type Contract = typeof contracts.$inferSelect;
```

### Ap√≥s Atualizar o Schema

```bash
# 1. Sincronize o banco com as novas colunas
npm run db:push --force

# 2. Reinicie o servidor
# (Ctrl+C e depois)
npm run dev
```

---

## üîß CORRE√á√ÉO 3: Mapeamento de Dados (CR√çTICO)

### Problema Identificado

```typescript
// ‚ùå FRONTEND ENVIAVA (Objetos aninhados)
{
  client_name: "Jo√£o",
  appearance_configs: {
    logo_url: "https://...",
    primary_color: "#FF0000"
  },
  verification_configs: {
    instructions: "Tire uma foto..."
  }
}

// ‚úÖ BACKEND ESPERA (Flat/Achatado)
{
  client_name: "Jo√£o",
  logo_url: "https://...",
  primary_color: "#FF0000",
  verification_instructions: "Tire uma foto..."
}
```

### Solu√ß√£o Completa

**Arquivo: `src/features/assinatura/pages/Admin.tsx`**

```typescript
import { useState } from "react";
import { useToast } from "@/hooks/use-toast";

export function Admin() {
  const { toast } = useToast();
  const [isLoading, setIsLoading] = useState(false);

  const handleCreateContract = async (formData: any) => {
    setIsLoading(true);
    
    try {
      // ========================================
      // MAPEAMENTO: Aninhado ‚Üí Flat (Achatado)
      // ========================================
      const flattenedData = {
        // Dados b√°sicos do cliente
        client_name: formData.client_name || "",
        client_cpf: (formData.client_cpf || "").replace(/\D/g, ""), // Remove m√°scara
        client_email: formData.client_email || "",
        client_phone: formData.client_phone || "",
        client_address: formData.client_address || "",
        client_city: formData.client_city || "",
        client_state: formData.client_state || "",
        client_zip: formData.client_zip || "",
        
        // Conte√∫do do contrato
        contract_html: formData.contract_html || "",
        
        // Apar√™ncia (flatten appearance_configs)
        logo_url: formData.appearance_configs?.logo_url || "",
        primary_color: formData.appearance_configs?.primary_color || "#3B82F6",
        text_color: formData.appearance_configs?.text_color || "#1F2937",
        font_family: formData.appearance_configs?.font_family || "Inter",
        company_name: formData.appearance_configs?.company_name || "",
        footer_text: formData.appearance_configs?.footer_text || "",
        
        // Verifica√ß√£o (flatten verification_configs)
        verification_instructions: formData.verification_configs?.instructions || "",
        verification_security_message: formData.verification_configs?.security_message || "",
        verification_icon_url: formData.verification_configs?.icon_url || "",
        security_message: formData.verification_configs?.security_message || "",
        header_background_color: formData.verification_configs?.header_background_color || "",
        
        // Tracker de progresso (flatten progress_tracker_configs)
        progress_step1_text: formData.progress_tracker_configs?.step1_text || "",
        progress_step2_text: formData.progress_tracker_configs?.step2_text || "",
        progress_step3_text: formData.progress_tracker_configs?.step3_text || "",
        progress_step4_text: formData.progress_tracker_configs?.step4_text || "",
        
        // Tela de sucesso (flatten reseller_welcome_configs)
        success_title: formData.reseller_welcome_configs?.title || "",
        success_message: formData.reseller_welcome_configs?.message || "",
        success_button_text: formData.reseller_welcome_configs?.button_text || "",
        
        // Links de apps (flatten app_promotion_configs)
        app_store_url: formData.app_promotion_configs?.app_store_url || "",
        play_store_url: formData.app_promotion_configs?.play_store_url || "",
      };

      console.log("üì§ DADOS MAPEADOS (Flat):", flattenedData);

      // Enviar para o backend
      const response = await fetch("/api/contracts", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(flattenedData),
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error("‚ùå Erro do servidor:", errorData);
        throw new Error(errorData.error || "Erro ao criar contrato");
      }

      const newContract = await response.json();
      console.log("‚úÖ Contrato criado:", newContract);

      toast({
        title: "Sucesso!",
        description: "Contrato criado com sucesso",
        variant: "default",
      });

      // Redirecionar ou limpar formul√°rio
      // window.location.href = `/admin/contracts/${newContract.id}`;

    } catch (error: any) {
      console.error("‚ùå Erro ao criar contrato:", error);
      
      toast({
        title: "Erro",
        description: error.message || "N√£o foi poss√≠vel criar o contrato",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div>
      {/* Seu formul√°rio aqui */}
      <button 
        onClick={() => handleCreateContract(formData)}
        disabled={isLoading}
      >
        {isLoading ? "Criando..." : "Criar Contrato"}
      </button>
    </div>
  );
}
```

### Valida√ß√£o no Backend

**Arquivo: `server/storage/assinatura-storage.ts`**

```typescript
import { db } from "../db";
import { contracts, insertContractSchema } from "@db/schema";

export async function createContract(data: any) {
  try {
    console.log("=" .repeat(80));
    console.log("üîç RECEBENDO DADOS NO STORAGE:");
    console.log(JSON.stringify(data, null, 2));
    console.log("=" .repeat(80));

    // Valida com Zod
    const validatedData = insertContractSchema.parse(data);
    console.log("‚úÖ Dados validados com sucesso");

    // Insere no banco
    const [newContract] = await db
      .insert(contracts)
      .values(validatedData)
      .returning();

    console.log("‚úÖ Contrato criado com ID:", newContract.id);
    console.log("üîó Access Token:", newContract.access_token);
    console.log("=" .repeat(80));

    return newContract;

  } catch (error: any) {
    console.error("=" .repeat(80));
    console.error("‚ùå ERRO NO STORAGE:");
    console.error("Tipo:", error.constructor.name);
    console.error("Mensagem:", error.message);
    
    if (error.name === "ZodError") {
      console.error("üî¥ Erros de valida√ß√£o:");
      error.errors.forEach((err: any) => {
        console.error(`  - ${err.path.join(".")}: ${err.message}`);
      });
    }
    
    console.error("=" .repeat(80));
    throw error;
  }
}
```

---

## üìã CHECKLIST DE APLICA√á√ÉO

Execute na ordem:

### Passo 1: Atualizar Schema
```bash
# 1. Substitua o conte√∫do de assinatura/shared/schema.ts
# 2. Execute:
npm run db:push --force
```

### Passo 2: Atualizar Frontend
```bash
# 1. Substitua o conte√∫do de src/features/assinatura/pages/Admin.tsx
# 2. Verifique se o mapeamento est√° correto
```

### Passo 3: Atualizar Storage
```bash
# 1. Substitua o conte√∫do de server/storage/assinatura-storage.ts
# 2. Adicione logs detalhados
```

### Passo 4: Testar
```bash
# 1. Reinicie o servidor
npm run dev

# 2. Limpe o cache do navegador (Ctrl+Shift+Delete)

# 3. Abra o console (F12)

# 4. Tente criar um contrato

# 5. Verifique os logs no terminal e no console
```

---

## üß™ TESTE DE VALIDA√á√ÉO

Use este payload de teste no console do navegador:

```javascript
// Cole no console (F12) para testar
const testPayload = {
  client_name: "Teste Sistema",
  client_cpf: "12345678901",
  client_email: "teste@sistema.com",
  contract_html: "<h1>Contrato de Teste</h1>",
  logo_url: "", // String vazia - deve aceitar
  primary_color: "#FF5733",
  verification_instructions: "Tire uma selfie",
  app_store_url: "", // String vazia - deve aceitar
};

fetch("/api/contracts", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(testPayload)
})
.then(r => r.json())
.then(console.log)
.catch(console.error);
```

**Resultado Esperado:**
```json
{
  "id": 1,
  "access_token": "uuid-gerado-aqui",
  "client_name": "Teste Sistema",
  "status": "pending",
  "created_at": "2026-01-01T12:00:00Z"
}
```

---

## ‚úÖ VERIFICA√á√ÉO FINAL

Ap√≥s aplicar todas as corre√ß√µes:

```sql
-- Verifique se todas as colunas existem
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'contracts'
ORDER BY ordinal_position;

-- Deve incluir:
-- verification_security_message
-- verification_icon_url
-- E todos os outros campos listados no schema
```

```bash
# Teste de cria√ß√£o manual
curl -X POST http://localhost:5000/api/contracts \
  -H "Content-Type: application/json" \
  -d '{
    "client_name": "Teste cURL",
    "client_cpf": "12345678901",
    "client_email": "curl@test.com",
    "contract_html": "<h1>Teste</h1>",
    "logo_url": ""
  }'
```

---

## üö® SE AINDA HOUVER ERRO

Forne√ßa os seguintes dados:

1. **Log completo** do terminal (√∫ltimas 50 linhas)
2. **Log completo** do console do navegador
3. **Status HTTP** da resposta (200, 400, 500, etc)
4. **Payload exato** que est√° sendo enviado
5. **Resultado do comando**:
   ```sql
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'contracts';
   ```

---

**Status do Documento**: Pronto para aplica√ß√£o
**Testado em**: PostgreSQL 14+, Node.js 18+
**√öltima atualiza√ß√£o**: Janeiro 2026